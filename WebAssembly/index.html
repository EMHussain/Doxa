<!doctype html>
<html lang="en-us">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		
		<title>Δoxa Binarization Framework - WebAssembly Demo</title>

		<!--
		https://www.w3schools.com/howto/howto_js_image_comparison.asp
		Copyright 1999-2019 by Refsnes Data
		https://www.w3schools.com/about/about_copyright.asp
		"Copying examples and code snippets for non-profit teaching and research."
		The code has been slightly altered for my needs. - Brandon Petty
		-->
		<link rel="stylesheet" type="text/css" href="w3schoolImgCompare.css">
		<script type="text/javascript" src="w3schoolImgCompare.js"></script>
		<style>
			.algInput {
				padding-right: 10px;
				display: none;
			}
		</style>
	</head>
	<body>
	<center>
	<h1>WebAssembly Demo - Local Adaptive Binarization</h1>
	This is an <b>experimental</b> project that exposes the ΔBF, written in C++, to JavaScript via WebAssembly.<br/>
	<a href="https://github.com/brandonmpetty/Doxa">https://github.com/brandonmpetty/Doxa</a><br/>
	<br/><br/>
	
	<div style="display: table;">
		<div style="padding-bottom: 10px; text-align: left;">
			<label for="algorithm" style="padding-right: 10px;">Algorithm:
				<select id="algorithm" onchange="selectAlgorithm(this.value); canvasToBinary();">
				</select>
			</label>
			
			<label for="windowSize" class="algInput">Window Size:
				<input type="number" id="window-el" name="windowSize"
					min="1" max="500" value="75" step="2" style="width: 4em">
			</label>
			
			<label for="kValue" class="algInput">K Value:
				<input type="number" id="k-el" name="kValue"
					min="-5.00" max="5.00" value="0.20" step="0.01" style="width: 5em">
			</label>
			
			<label for="threshold" class="algInput">Threshold:
				<input type="number" id="threshold-el" name="threshold"
					min="0" max="255" value="100" step="1" style="width: 4em">
			</label>
			
			<label for="contrastLimit" class="algInput">Contrast Limit:
				<input type="number" id="contrast-limit-el" name="contrastLimit"
					min="0" max="255" value="25" step="1" style="width: 4em">
			</label>
			
			<button id="apply" type="button" onclick="canvasToBinary();">Apply</button>
		</div>
		<div class="img-comp-container">
			<div class="img-comp-img">
				<canvas id="binaryCanvas">
					Sorry. Your browser does not support HTML5 canvas element.
				</canvas>
			</div>
			<div class="img-comp-img img-comp-overlay">
				<canvas id="sourceCanvas">
					Sorry. Your browser does not support HTML5 canvas element.
				</canvas>
			</div>
		</div>
		<div style="padding-top: 10px; text-align: left;">
			Author(s): <span id="authors"></span><br/>
			Citation: <span id="citation" /></span>
		</div>
	</div>
	</center>
	
	<script type="text/javascript">
		var srcImage;
		var dstImage;
		var currentAlgorithm;
		
        function drawImgToCanvas(img, id) {
            var canvas = document.getElementById(id);
            var ctx = canvas.getContext('2d');

            canvas.width = img.width;
            canvas.height = img.height;

            ctx.drawImage(img, 0, 0);
        }
		
		function canvasToBinary() {
			// Update params
			for (var key in currentAlgorithm.params) {
				var el = document.getElementById(key+'-el');
				currentAlgorithm.params[key] = Number(el.value);
			}
		
			// Convert to Binary
			Doxa.toBinary(dstImage, currentAlgorithm.params);
			
			// Draw to Canvas
			dstImage.draw('binaryCanvas');
		}
		
		function initializeImages() {
			// Read directly from the canvas
            var canvas = document.getElementById('sourceCanvas');
            var ctx = canvas.getContext('2d');
			var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
			
			// Create an Image object for our input and output images
			// Our source image will never change
			srcImage = srcImage || new Doxa.Image(imageData.width, imageData.height).load(imageData);
			dstImage = dstImage || new Doxa.Image(imageData.width, imageData.height);
		}
		
		function initializeAlgorithm() {		
			// Update Authorship
			document.getElementById('authors').textContent = currentAlgorithm.authors;
			document.getElementById('citation').textContent = currentAlgorithm.title + " : " + currentAlgorithm.date;
			
			// Convert the image to binary
			Doxa.initialize(currentAlgorithm.enum, srcImage);
		}
		
		function initializeInputs() {
			// Hide Apply button if there are no keys, else show it
			document.getElementById('apply').style.display = 
				Object.keys(currentAlgorithm.params).length === 0 ? 'none' : 'inline-block';
		
			// Hide all input elements
			var divsToHide = document.getElementsByClassName("algInput");
			for(var i = 0; i < divsToHide.length; ++i){
				divsToHide[i].style.display = 'none';
			}
			
			// Set all algorithm defaults based on algorithm parameters
			for (var key in currentAlgorithm.params) {
				var el = document.getElementById(key+'-el');
				el.value = currentAlgorithm.params[key];
				el.parentElement.style.display = 'inline-block';
			}
		}
		
		function loadAlgorithms() {
			var options = "";
			Doxa.Algorithm.forEach(function(alg) {
				options += "<option value='" + alg.enum + "'>" + alg.name + "</option>";
			});
			
			document.getElementById('algorithm').innerHTML = options;
		}
		
		function selectAlgorithm(value) {
			// The order of this call does matter since we are dealing with a global.
			currentAlgorithm = Doxa.Algorithm[value];
			
			initializeInputs();
			initializeAlgorithm();
		}
    </script>
    <script type="text/javascript" src="doxaWasm.js"></script>
	<script type="text/javascript" src="doxa.js"></script>
	<script>
		Module.onRuntimeInitialized = async _ => {
			// Create our algorithms selection list
			loadAlgorithms();
			
			// Initialize our image slider
			var sourceImg = new Image();
			sourceImg.src = '../Images/2JohnC1V3.png';
			sourceImg.onload = function() {
				// Draw image to Canvas
				drawImgToCanvas(sourceImg, 'sourceCanvas');
				
				// Initialize Doxa Image memory for our Color and Binary images
				initializeImages();
				
				// Convert the color image to binary and show on the other Canvas
				selectAlgorithm(0); // 0 = Otsu
				canvasToBinary();
				
				// Initialize the comparison code
				initComparisons();
			};
		};
	</script>
  </body>
</html>


